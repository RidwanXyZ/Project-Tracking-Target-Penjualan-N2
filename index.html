<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Penjualan</title>

  <!-- Menggunakan Tailwind CSS dari CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Menggunakan DaisyUI dari CDN -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.2/dist/full.min.css" rel="stylesheet" type="text/css" />
  <!-- Menggunakan Font Awesome untuk ikon -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <!-- Menggunakan library SheetJS untuk export ke Excel -->
  <script src="https://cdn.jsdelivr.net/npm/sheetjs/dist/xlsx.full.min.js"></script>

  <!-- Menggunakan font Inter dari Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* Mengatur font global */
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="min-h-screen p-4 md:p-8 bg-base-200 text-base-content">

  <!-- Main container dengan layout responsif -->
  <div class="container mx-auto space-y-8">
    <header class="text-center py-4">
      <h1 class="text-4xl md:text-5xl font-extrabold text-primary mb-2">Dashboard Penjualan</h1>
      <p class="text-sm md:text-md text-base-content/80">Monitor data penjualan harian Anda dengan mudah.</p>
    </header>

    <!-- ======================================== -->
    <!-- SECTION 1: INPUT DATA -->
    <!-- ======================================== -->
    <section>
      <div class="card bg-base-100 shadow-xl rounded-2xl">
        <div class="card-body">
          <h2 class="card-title text-secondary mb-4">Input Data Penjualan</h2>
          <form id="sales-form" class="space-y-4">
            <!-- Input Tanggal -->
            <div>
              <label for="tanggal" class="label">
                <span class="label-text font-semibold">Tanggal</span>
              </label>
              <input type="date" id="tanggal" class="input input-bordered input-primary w-full" required>
            </div>
            
            <!-- Input N2 & Tambal -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="n2" class="label">
                  <span class="label-text font-semibold">N2</span>
                </label>
                <input type="number" id="n2" class="input input-bordered input-secondary w-full" placeholder="Rp 10.000" required>
              </div>
              <div>
                <label for="tambal" class="label">
                  <span class="label-text font-semibold">Tambal</span>
                </label>
                <input type="number" id="tambal" class="input input-bordered input-secondary w-full" placeholder="Rp 0">
              </div>
            </div>

            <!-- Tombol Simpan/Update Data -->
            <button type="submit" id="btn-submit" class="btn btn-primary w-full mt-4">Simpan Data</button>
          </form>
        </div>
      </div>
    </section>

    <!-- ======================================== -->
    <!-- SECTION 2: TABEL DATA -->
    <!-- ======================================== -->
    <section>
      <div class="card bg-base-100 shadow-xl rounded-2xl">
        <div class="card-body">
          <h2 class="card-title text-secondary mb-4">Data Penjualan</h2>

          <div class="overflow-x-auto">
            <table class="table table-zebra w-full text-base-content">
              <!-- table head -->
              <thead>
                <tr class="bg-base-300">
                  <th class="py-3">
                    Tanggal
                    <!-- Tombol untuk mengubah urutan sorting -->
                    <button id="sort-btn" class="btn btn-ghost btn-sm">
                      <i id="sort-icon" class="fa-solid fa-sort-down"></i>
                    </button>
                  </th>
                  <th class="py-3">N2 (Rp)</th>
                  <th class="py-3">Tambal (Rp)</th>
                  <th class="py-3">Total (Rp)</th>
                  <th class="py-3">Aksi</th>
                </tr>
              </thead>
              <!-- table body -->
              <tbody id="table-body">
                <!-- Data akan di-render secara dinamis -->
                <tr><td colspan="5" class="text-center py-4">Memuat data...</td></tr>
              </tbody>
              <!-- table footer -->
              <tfoot class="font-bold bg-base-300">
                <tr>
                  <td>Total</td>
                  <td id="total-n2">Rp 0</td>
                  <td id="total-tambal">Rp 0</td>
                  <td id="total-keseluruhan">Rp 0</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
          
          <!-- Tombol Hapus Semua Data -->
          <div class="mt-4 text-center">
            <button id="reset-data-btn" class="btn btn-warning w-full">Hapus Semua Data</button>
          </div>

          <!-- Tombol Download Data -->
          <div class="mt-4 text-center">
            <div class="dropdown dropdown-top dropdown-hover w-full">
              <div tabindex="0" role="button" class="btn btn-accent w-full">
                <i class="fa-solid fa-download mr-2"></i> Download Data
              </div>
              <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-full p-2 shadow-lg">
                <li><a id="download-json-btn">JSON</a></li>
                <li><a id="download-xlsx-btn">Excel (.xlsx)</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ======================================== -->
    <!-- SECTION 3: INFOGRAFIS -->
    <!-- ======================================== -->
    <section>
      <div class="card bg-base-100 shadow-xl rounded-2xl">
        <div class="card-body">
          <h2 class="card-title text-secondary mb-4">Ringkasan Penjualan</h2>

          <!-- Menggunakan komponen stats dari DaisyUI -->
          <div class="stats stats-vertical md:stats-horizontal bg-base-300 shadow-lg text-center rounded-box w-full">
            <div class="stat">
              <div class="stat-title">Jumlah Data</div>
              <div id="inf-jumlah" class="stat-value text-green-400">0</div>
            </div>
            <div class="stat">
              <div class="stat-title">Total N2</div>
              <div id="inf-n2" class="stat-value text-yellow-400">Rp 0</div>
            </div>
            <div class="stat">
              <div class="stat-title">Total Tambal</div>
              <div id="inf-tambal" class="stat-value text-yellow-400">Rp 0</div>
            </div>
            <div class="stat">
              <div class="stat-title">Total Keseluruhan</div>
              <div id="inf-keseluruhan" class="stat-value text-cyan-400">Rp 0</div>
            </div>
          </div>

          <!-- Input Target -->
          <div class="mt-8">
            <label for="target" class="label">
              <span class="label-text font-semibold">Target Penjualan</span>
            </label>
            <input type="number" id="target" class="input input-bordered w-full" placeholder="Masukkan target">
          </div>

          <!-- Sisa Target -->
          <div class="mt-4 stats shadow-lg bg-base-300 rounded-box text-center">
            <div class="stat">
              <div class="stat-title">Sisa Target</div>
              <div id="sisa-target" class="stat-value text-red-400">Rp 0</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Modal Konfirmasi Hapus -->
    <dialog id="delete_modal" class="modal">
      <div class="modal-box bg-base-100 rounded-2xl">
        <h3 class="font-bold text-lg text-primary">Konfirmasi Hapus</h3>
        <p class="py-4">Apakah Anda yakin ingin menghapus data ini?</p>
        <div class="modal-action">
          <button id="confirm-delete" class="btn btn-error">Ya, Hapus</button>
          <button class="btn" onclick="document.getElementById('delete_modal').close()">Batal</button>
        </div>
      </div>
    </dialog>

    <!-- Modal Konfirmasi Hapus Semua Data -->
    <dialog id="reset_modal" class="modal">
      <div class="modal-box bg-base-100 rounded-2xl">
        <h3 class="font-bold text-lg text-error">PERINGATAN!</h3>
        <p class="py-4">Tindakan ini akan **menghapus semua data** di spreadsheet Anda. Apakah Anda yakin ingin melanjutkan?</p>
        <div class="modal-action">
          <button id="confirm-reset" class="btn btn-error">Ya, Hapus Semua</button>
          <button class="btn" onclick="document.getElementById('reset_modal').close()">Batal</button>
        </div>
      </div>
    </dialog>
    
    <!-- Modal Pemberitahuan -->
    <dialog id="info_modal" class="modal">
      <div class="modal-box bg-base-100 rounded-2xl">
        <h3 id="info-title" class="font-bold text-lg text-primary">Pemberitahuan</h3>
        <p id="info-message" class="py-4">Pesan Anda di sini.</p>
        <div class="modal-action">
          <button class="btn" onclick="document.getElementById('info_modal').close()">OK</button>
        </div>
      </div>
    </dialog>
  </div>
  
  <!-- ======================================== -->
  <!-- JAVASCRIPT UTAMA -->
  <!-- ======================================== -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {

      // URL API dari SheetDB.io
      const API_URL = 'https://sheetdb.io/api/v1/rjpiyt4i6zpw2'; 

      // ===============================
      // Utility: Format Rupiah & Tanggal
      // ===============================
      function formatRupiah(num) {
        return 'Rp ' + (num || 0).toLocaleString('id-ID', {
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        });
      }

      function showModal(title, message) {
        document.getElementById('info-title').textContent = title;
        document.getElementById('info-message').textContent = message;
        document.getElementById('info_modal').showModal();
      }
      
      // Fungsi untuk mengonversi nomor seri Excel menjadi tanggal
      function serialToDate(serial) {
          // Tanggal awal Excel (1 Januari 1900)
          const excelEpoch = new Date(1900, 0, 1);
          const date = new Date(excelEpoch.getTime() + (serial - 2) * 24 * 60 * 60 * 1000);
          return date;
      }
      
      // Fungsi untuk format tanggal yang lebih kuat
      function formatDate(dateValue) {
          let date;
          // Cek jika datanya adalah nomor seri
          if (typeof dateValue === 'number' || (typeof dateValue === 'string' && !isNaN(Number(dateValue)))) {
              date = serialToDate(Number(dateValue));
          } else {
              // Jika datanya sudah dalam format YYYY-MM-DD
              const parts = dateValue.split('-');
              if (parts.length === 3) {
                  const year = parseInt(parts[0], 10);
                  const month = parseInt(parts[1], 10) - 1; 
                  const day = parseInt(parts[2], 10);
                  date = new Date(year, month, day);
              } else {
                  // Jika format tidak dikenali, kembalikan nilai aslinya
                  return dateValue;
              }
          }
          
          const options = { year: 'numeric', month: 'long', day: 'numeric' };
          return date.toLocaleDateString('id-ID', options);
      }

      // ===============================
      // DOM Elements & State Management
      // ===============================
      const tableBody = document.getElementById('table-body');
      const totalN2 = document.getElementById('total-n2');
      const totalTambal = document.getElementById('total-tambal');
      const totalKeseluruhan = document.getElementById('total-keseluruhan');
      const infJumlah = document.getElementById('inf-jumlah');
      const infN2 = document.getElementById('inf-n2');
      const infTambal = document.getElementById('inf-tambal');
      const infKeseluruhan = document.getElementById('inf-keseluruhan');
      const inputTarget = document.getElementById('target');
      const sisaTarget = document.getElementById('sisa-target');
      const salesForm = document.getElementById('sales-form');
      const btnSubmit = document.getElementById('btn-submit');
      const deleteModal = document.getElementById('delete_modal');
      const resetModal = document.getElementById('reset_modal');
      const confirmDeleteBtn = document.getElementById('confirm-delete');
      const confirmResetBtn = document.getElementById('confirm-reset');
      const resetDataBtn = document.getElementById('reset-data-btn');
      const sortBtn = document.getElementById('sort-btn');
      const sortIcon = document.getElementById('sort-icon');
      const downloadJsonBtn = document.getElementById('download-json-btn');
      const downloadXlsxBtn = document.getElementById('download-xlsx-btn');

      let data = [];
      let editingRow = null;
      let rowToDeleteTanggal = null;
      let sortOrder = 'desc';

      // ===============================
      // CRUD Operations with SheetDB API
      // ===============================

      // Fungsi untuk mengambil data dari SheetDB
      async function fetchData() {
        try {
          tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4">Memuat data...</td></tr>';
          const response = await fetch(API_URL);
          if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
          }
          data = await response.json();
          renderTable();
        } catch (error) {
          console.error('Error saat mengambil data:', error);
          showModal('Error', 'Gagal mengambil data dari SheetDB. Pastikan URL API benar.');
          tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-error">Gagal memuat data.</td></tr>';
        }
      }

      // Fungsi untuk menyimpan data baru
      async function postData(newData) {
        console.log('Mengirim data baru:', newData);
        try {
          const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: newData })
          });
          if (response.status === 400) {
            const errorText = await response.text();
            console.error('API SheetDB mengembalikan error 400:', errorText);
            throw new Error(`Error HTTP: ${response.status}. Periksa nama kolom (Tanggal, N2, Tambal) di Google Spreadsheet Anda.`);
          }
          if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
          }
          await response.json();
          showModal('Berhasil', 'Data berhasil disimpan!');
          await fetchData();
        } catch (error) {
          console.error('Error saat menyimpan data:', error);
          showModal('Gagal', `Gagal menyimpan data: ${error.message}`);
        }
      }

      // Fungsi untuk memperbarui data yang sudah ada
      async function updateData(tanggal, updatedData) {
        console.log(`Memperbarui data untuk tanggal ${tanggal}:`, updatedData);
        try {
          const response = await fetch(`${API_URL}/Tanggal/${tanggal}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: updatedData })
          });
          if (response.status === 400) {
            const errorText = await response.text();
            console.error('API SheetDB mengembalikan error 400:', errorText);
            throw new Error(`Error HTTP: ${response.status}. Periksa nama kolom (Tanggal, N2, Tambal) di Google Spreadsheet Anda.`);
          }
          if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
          }
          await response.json();
          showModal('Berhasil', 'Data berhasil diperbarui!');
          await fetchData();
        } catch (error) {
          console.error('Error saat memperbarui data:', error);
          showModal('Gagal', `Gagal memperbarui data: ${error.message}`);
        }
      }

      // Fungsi untuk menghapus data
      async function deleteData(tanggal) {
        console.log(`Menghapus data untuk tanggal: ${tanggal}`);
        try {
          const response = await fetch(`${API_URL}/Tanggal/${tanggal}`, {
            method: 'DELETE'
          });
          if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
          }
          await response.json();
          showModal('Berhasil', 'Data berhasil dihapus!');
          await fetchData();
        } catch (error) {
          console.error('Error saat menghapus data:', error);
          showModal('Gagal', `Gagal menghapus data: ${error.message}`);
        }
      }

      // Fungsi untuk menghapus semua data
      async function deleteAllData() {
        console.log('Menghapus semua data...');
        if (data.length === 0) {
          showModal('Informasi', 'Tidak ada data untuk dihapus.');
          return;
        }

        try {
          const deletePromises = data.map(row => {
            return fetch(`${API_URL}/Tanggal/${row.Tanggal}`, {
              method: 'DELETE'
            }).then(response => {
              if (!response.ok) {
                return Promise.reject(new Error(`Gagal menghapus data untuk Tanggal ${row.Tanggal}. Error: ${response.status}`));
              }
              return response.json();
            });
          });

          await Promise.all(deletePromises);
          showModal('Berhasil', 'Semua data berhasil dihapus!');
          await fetchData();
        } catch (error) {
          console.error('Error saat menghapus semua data:', error);
          showModal('Gagal', `Gagal menghapus semua data: ${error.message}`);
        }
      }

      // ===============================
      // Render Tabel dan Infografis
      // ===============================
      function renderTable() {
        tableBody.innerHTML = '';
        let sumN2 = 0, sumTambal = 0;

        const sortedData = [...data].sort((a, b) => {
          const dateA = new Date(a.Tanggal);
          const dateB = new Date(b.Tanggal);
          if (sortOrder === 'desc') {
            return dateB - dateA;
          } else {
            return dateA - dateB;
          }
        });

        sortedData.forEach((row) => {
          const n2 = parseInt(row.N2) || 0;
          const tambal = parseInt(row.Tambal) || 0;
          sumN2 += n2;
          sumTambal += tambal;

          const totalRow = n2 + tambal;

          const tr = document.createElement('tr');
          tr.classList.add('hover:bg-base-200', 'transition-colors', 'duration-200');
          tr.innerHTML = `
            <td class="whitespace-nowrap">${formatDate(row.Tanggal)}</td>
            <td class="whitespace-nowrap">${formatRupiah(n2)}</td>
            <td class="whitespace-nowrap">${formatRupiah(tambal)}</td>
            <td class="whitespace-nowrap font-semibold">${formatRupiah(totalRow)}</td>
            <td class="flex flex-col sm:flex-row gap-2">
              <button class="btn btn-sm btn-info text-xs md:text-sm" onclick="editRow('${row.Tanggal}')">Edit</button>
              <button class="btn btn-sm btn-error text-xs md:text-sm" onclick="showDeleteModal('${row.Tanggal}')">Hapus</button>
            </td>
          `;
          tableBody.appendChild(tr);
        });

        totalN2.textContent = formatRupiah(sumN2);
        totalTambal.textContent = formatRupiah(sumTambal);
        totalKeseluruhan.textContent = formatRupiah(sumN2 + sumTambal);

        updateInfografis(sumN2, sumTambal);
      }

      function updateInfografis(sumN2, sumTambal) {
        const total = sumN2 + sumTambal;
        infJumlah.textContent = data.length;
        infN2.textContent = formatRupiah(sumN2);
        infTambal.textContent = formatRupiah(sumTambal);
        infKeseluruhan.textContent = formatRupiah(total);

        const targetVal = parseInt(inputTarget.value) || 0;
        const remainingTarget = targetVal - total;
        sisaTarget.textContent = formatRupiah(remainingTarget);
        sisaTarget.classList.toggle('text-red-400', remainingTarget > 0);
        sisaTarget.classList.toggle('text-green-400', remainingTarget <= 0);
      }
      
      // ===============================
      // Fungsi Download
      // ===============================
      function download(data, filename, type) {
          const file = new Blob([data], { type: type });
          const a = document.createElement('a');
          const url = URL.createObjectURL(file);
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          setTimeout(() => {
              document.body.removeChild(a);
              window.URL.revokeObjectURL(url);
          }, 0);
      }

      function downloadJson() {
          const formattedData = JSON.stringify(data, null, 2);
          download(formattedData, 'data_penjualan.json', 'text/json');
          showModal('Berhasil', 'File JSON berhasil diunduh!');
      }

      function downloadXlsx() {
          // Tambahkan pemeriksaan untuk memastikan library XLSX telah dimuat
          if (typeof XLSX === 'undefined') {
              console.error("XLSX library not loaded!");
              showModal('Error', 'Gagal mengunduh file. Library untuk Excel tidak ditemukan. Silakan muat ulang halaman atau coba lagi nanti.');
              return;
          }
          // Buat salinan data dan konversi format tanggal
          const formattedData = data.map(row => {
              const newRow = { ...row };
              if (newRow.Tanggal) {
                  // Jika tanggal adalah nomor seri, ubah ke format yang bisa dibaca
                  if (typeof newRow.Tanggal === 'number' || (typeof newRow.Tanggal === 'string' && !isNaN(Number(newRow.Tanggal)))) {
                      newRow.Tanggal = serialToDate(Number(newRow.Tanggal)).toISOString().split('T')[0];
                  }
              }
              return newRow;
          });

          const worksheet = XLSX.utils.json_to_sheet(formattedData);
          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, worksheet, "Data Penjualan");
          XLSX.writeFile(workbook, "data_penjualan.xlsx");
          showModal('Berhasil', 'File Excel berhasil diunduh!');
      }

      // ===============================
      // Event Listeners
      // ===============================

      salesForm.addEventListener('submit', (e) => {
        e.preventDefault();

        const tanggal = document.getElementById('tanggal').value;
        const n2 = parseInt(document.getElementById('n2').value) || 0;
        const tambal = parseInt(document.getElementById('tambal').value) || 0;

        const formData = {
          Tanggal: tanggal, // Pastikan nama kolom sesuai dengan header di Google Spreadsheet
          N2: n2,
          Tambal: tambal
        };

        if (editingRow) {
          updateData(editingRow.Tanggal, formData);
        } else {
          postData(formData);
        }
        
        // Reset formulir setelah pengiriman
        salesForm.reset();
        btnSubmit.textContent = 'Simpan Data';
        editingRow = null;
      });

      window.editRow = (tanggal) => {
        const rowToEdit = data.find(row => row.Tanggal === tanggal);
        if (rowToEdit) {
          document.getElementById('tanggal').value = rowToEdit.Tanggal;
          document.getElementById('n2').value = rowToEdit.N2;
          document.getElementById('tambal').value = rowToEdit.Tambal;
          editingRow = rowToEdit;
          btnSubmit.textContent = 'Update Data';
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      };

      window.showDeleteModal = (tanggal) => {
        rowToDeleteTanggal = tanggal;
        deleteModal.showModal();
      };

      confirmDeleteBtn.addEventListener('click', () => {
        if (rowToDeleteTanggal) {
          deleteData(rowToDeleteTanggal);
          rowToDeleteTanggal = null;
          deleteModal.close();
        }
      });

      resetDataBtn.addEventListener('click', () => {
        resetModal.showModal();
      });

      confirmResetBtn.addEventListener('click', () => {
        deleteAllData();
        resetModal.close();
      });

      inputTarget.addEventListener('input', () => {
        const sumN2 = data.reduce((acc, row) => acc + (parseInt(row.N2) || 0), 0);
        const sumTambal = data.reduce((acc, row) => acc + (parseInt(row.Tambal) || 0), 0);
        updateInfografis(sumN2, sumTambal);
      });

      sortBtn.addEventListener('click', () => {
        sortOrder = sortOrder === 'desc' ? 'asc' : 'desc';
        sortIcon.classList.toggle('fa-sort-up', sortOrder === 'asc');
        sortIcon.classList.toggle('fa-sort-down', sortOrder === 'desc');
        renderTable();
      });

      // Event listener untuk tombol download
      downloadJsonBtn.addEventListener('click', downloadJson);
      downloadXlsxBtn.addEventListener('click', downloadXlsx);

      // Ambil data pertama kali saat halaman dimuat
      fetchData();
    });
  </script>

</body>
</html>
